<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•æ‰§è¡Œå¯è§†åŒ– - Debugæ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d30;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            color: #4ec9b0;
            font-size: 18px;
            font-weight: 600;
        }

        .header select {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 400px 1fr 350px;
            overflow: hidden;
        }

        .panel {
            background: #252526;
            border-right: 1px solid #3e3e42;
            overflow: auto;
        }

        .panel-title {
            background: #2d2d30;
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
            border-bottom: 1px solid #3e3e42;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .code-panel {
            padding: 15px;
        }

        .code-line {
            padding: 4px 8px;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre;
            cursor: pointer;
            transition: background 0.2s;
        }

        .code-line:hover {
            background: #2a2d2e;
        }

        .code-line.active {
            background: #264f78;
            border-left: 3px solid #007acc;
        }

        .code-line.completed {
            background: #1a3a1a;
        }

        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        .comment { color: #6a9955; }
        .function { color: #dcdcaa; }

        .canvas-panel {
            display: flex;
            flex-direction: column;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #1e1e1e;
        }

        canvas {
            display: block;
        }

        .controls {
            background: #2d2d30;
            padding: 15px;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 10px;
        }

        .zoom-controls button {
            padding: 6px 12px;
            font-size: 12px;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.2s;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #3e3e42;
            color: #888;
            cursor: not-allowed;
        }

        button.play-btn {
            background: #16825d;
        }

        button.play-btn:hover {
            background: #1a9870;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .speed-control input {
            width: 100px;
        }

        .variables-panel {
            padding: 15px;
        }

        .var-item {
            margin-bottom: 12px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 4px;
            border-left: 3px solid #4ec9b0;
        }

        .var-name {
            color: #9cdcfe;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .var-value {
            color: #ce9178;
            font-size: 13px;
            word-break: break-all;
        }

        .call-stack {
            padding: 15px;
        }

        .stack-frame {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: #1e1e1e;
            border-radius: 4px;
            border-left: 3px solid #569cd6;
            font-size: 12px;
        }

        .stack-frame.active {
            background: #264f78;
            border-left-color: #007acc;
        }

        .stats {
            padding: 15px;
            background: #1e1e1e;
            margin: 10px 15px;
            border-radius: 4px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid #3e3e42;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #cccccc;
        }

        .stat-value {
            color: #4ec9b0;
            font-weight: 600;
        }

        .step-info {
            padding: 12px 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #3e3e42;
            font-size: 12px;
            line-height: 1.5;
        }

        .step-info strong {
            color: #4ec9b0;
        }

        .progress-bar {
            height: 3px;
            background: #3e3e42;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #007acc;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ› ç®—æ³•æ‰§è¡Œå¯è§†åŒ– - Debugæ¨¡å¼</h1>
        <select id="algorithmSelect" onchange="loadAlgorithm()">
            <option value="combinationSum">ç»„åˆæ€»å’Œ (å›æº¯)</option>
            <option value="permutations">å…¨æ’åˆ— (å›æº¯)</option>
            <option value="maxDepth">äºŒå‰æ ‘æœ€å¤§æ·±åº¦ (é€’å½’)</option>
        </select>
    </div>

    <div class="progress-bar">
        <div class="progress-bar-fill" id="progressBar"></div>
    </div>

    <div class="main">
        <!-- å·¦ä¾§ï¼šä»£ç é¢æ¿ -->
        <div class="panel">
            <div class="panel-title">ğŸ“„ Javaä»£ç </div>
            <div class="code-panel" id="codePanel"></div>

            <div class="panel-title" style="margin-top: 20px;">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</div>
            <div class="stats" id="statsPanel"></div>
        </div>

        <!-- ä¸­é—´ï¼šæ ‘å½¢å¯è§†åŒ– -->
        <div class="canvas-panel">
            <div class="panel-title">ğŸŒ² å†³ç­–æ ‘/é€’å½’æ ‘</div>
            <div class="step-info" id="stepInfo">
                <strong>å½“å‰æ­¥éª¤:</strong> å‡†å¤‡å¼€å§‹æ‰§è¡Œ...
            </div>
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            <div class="controls">
                <button onclick="resetExecution()">â® é‡ç½®</button>
                <button onclick="stepBackward()" id="stepBackBtn">âª ä¸Šä¸€æ­¥</button>
                <button onclick="stepForward()" id="stepForwardBtn">â© ä¸‹ä¸€æ­¥</button>
                <button class="play-btn" onclick="togglePlay()" id="playBtn">â–¶ æ’­æ”¾</button>
                <div class="speed-control">
                    <label>é€Ÿåº¦:</label>
                    <input type="range" id="speedSlider" min="100" max="2000" value="800" step="100">
                    <span id="speedValue">0.8s</span>
                </div>
                <div class="zoom-controls">
                    <button onclick="zoomIn()">ğŸ”+</button>
                    <button onclick="zoomOut()">ğŸ”-</button>
                    <button onclick="fitToView()">ğŸ“ é€‚åº”çª—å£</button>
                    <button onclick="resetZoom()">ğŸ”„ é‡ç½®</button>
                    <span id="zoomLevel">100%</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå˜é‡å’Œè°ƒç”¨æ ˆ -->
        <div class="panel">
            <div class="panel-title">ğŸ“¦ å˜é‡ç›‘è§†</div>
            <div class="variables-panel" id="variablesPanel"></div>

            <div class="panel-title" style="margin-top: 20px;">ğŸ“š è°ƒç”¨æ ˆ</div>
            <div class="call-stack" id="callStack"></div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let canvas, ctx;
        let currentAlgorithm = 'combinationSum';
        let executionSteps = [];
        let currentStep = 0;
        let isPlaying = false;
        let playInterval = null;
        let treeNodes = [];

        // ç¼©æ”¾å’Œå¹³ç§»
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let autoFitEnabled = true; // è‡ªåŠ¨é€‚åº”æ ‡å¿—

        // åˆå§‹åŒ–
        window.onload = function() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            // ä¿®å¤é«˜DPIå±å¹•æ¨¡ç³Šé—®é¢˜
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);

            // è°ƒæ•´å¤§å°ç›‘å¬
            window.addEventListener('resize', () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                ctx.scale(dpr, dpr);
                drawTree();
            });

            document.getElementById('speedSlider').addEventListener('input', (e) => {
                const speed = e.target.value;
                document.getElementById('speedValue').textContent = (speed / 1000).toFixed(1) + 's';
            });

            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                autoFitEnabled = false; // æ‰‹åŠ¨ç¼©æ”¾åç¦ç”¨è‡ªåŠ¨é€‚åº”
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale *= delta;
                scale = Math.max(0.1, Math.min(5, scale));
                document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
                drawTree();
            });

            // é¼ æ ‡æ‹–æ‹½å¹³ç§»
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStartX = e.clientX - offsetX;
                dragStartY = e.clientY - offsetY;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    autoFitEnabled = false; // æ‰‹åŠ¨å¹³ç§»åç¦ç”¨è‡ªåŠ¨é€‚åº”
                    offsetX = e.clientX - dragStartX;
                    offsetY = e.clientY - dragStartY;
                    drawTree();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                canvas.style.cursor = 'default';
            });

            canvas.style.cursor = 'grab';

            loadAlgorithm();
        };

        // ç®—æ³•æ•°æ®å®šä¹‰
        const algorithms = {
            combinationSum: {
                name: 'ç»„åˆæ€»å’Œ',
                code: `<span class="keyword">public</span> <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; <span class="function">combinationSum</span>(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target) {
    <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; result = <span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;();
    <span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt; path = <span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;();
    <span class="function">backtrack</span>(candidates, target, <span class="number">0</span>, <span class="number">0</span>, path, result);
    <span class="keyword">return</span> result;
}

<span class="keyword">void</span> <span class="function">backtrack</span>(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> start,
                  <span class="keyword">int</span> sum, <span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt; path,
                  <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; result) {
    <span class="comment">// è¾¾åˆ°ç›®æ ‡</span>
    <span class="keyword">if</span> (sum == target) {
        result.add(<span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;(path));
        <span class="keyword">return</span>;
    }

    <span class="comment">// å‰ªæï¼šå’Œå·²ç»è¶…è¿‡ç›®æ ‡</span>
    <span class="keyword">if</span> (sum &gt; target) {
        <span class="keyword">return</span>;
    }

    <span class="comment">// å°è¯•æ¯ä¸ªå€™é€‰æ•°</span>
    <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; candidates.length; i++) {
        path.add(candidates[i]);
        <span class="function">backtrack</span>(candidates, target, i, sum + candidates[i], path, result);
        path.remove(path.size() - <span class="number">1</span>);
    }
}`,
                steps: [
                    {
                        line: 3,
                        description: 'åˆå§‹åŒ–ç»“æœåˆ—è¡¨å’Œè·¯å¾„',
                        variables: { result: '[]', path: '[]', target: 7, candidates: '[2,3,6,7]' },
                        callStack: ['combinationSum(candidates=[2,3,6,7], target=7)'],
                        node: { displayText: '[]', depth: 0, type: 'ROOT', sum: 0 }
                    },
                    {
                        line: 4,
                        description: 'å¼€å§‹å›æº¯ï¼Œå°è¯•å€™é€‰æ•° 2',
                        variables: { result: '[]', path: '[]', sum: 0, start: 0 },
                        callStack: ['combinationSum(...)', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[]', depth: 0, type: 'INTERNAL', sum: 0 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 2ï¼ŒåŠ å…¥è·¯å¾„',
                        variables: { result: '[]', path: '[2]', sum: 2, i: 0 },
                        callStack: ['combinationSum(...)', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[2]', depth: 1, type: 'INTERNAL', sum: 2, choice: 2, parent: 0 }
                    },
                    {
                        line: 25,
                        description: 'é€’å½’è°ƒç”¨ï¼Œç»§ç»­é€‰æ‹© 2',
                        variables: { result: '[]', path: '[2]', sum: 2, start: 0 },
                        callStack: ['combinationSum(...)', 'backtrack(start=0, sum=0)', 'backtrack(start=0, sum=2, path=[2])'],
                        node: { displayText: '[2]', depth: 1, type: 'INTERNAL', sum: 2 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [2,2]',
                        variables: { result: '[]', path: '[2,2]', sum: 4, i: 0 },
                        callStack: ['...', 'backtrack(start=0, sum=2, path=[2])'],
                        node: { displayText: '[2,2]', depth: 2, type: 'INTERNAL', sum: 4, choice: 2, parent: 1 }
                    },
                    {
                        line: 25,
                        description: 'é€’å½’è°ƒç”¨',
                        variables: { result: '[]', path: '[2,2]', sum: 4, start: 0 },
                        callStack: ['...', 'backtrack(start=0, sum=4, path=[2,2])'],
                        node: { displayText: '[2,2]', depth: 2, type: 'INTERNAL', sum: 4 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [2,2,2]',
                        variables: { result: '[]', path: '[2,2,2]', sum: 6, i: 0 },
                        callStack: ['...', 'backtrack(start=0, sum=4, path=[2,2])'],
                        node: { displayText: '[2,2,2]', depth: 3, type: 'INTERNAL', sum: 6, choice: 2, parent: 2 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [2,2,2,2]ï¼Œå’Œ=8 > 7',
                        variables: { result: '[]', path: '[2,2,2,2]', sum: 8, i: 0 },
                        callStack: ['...', 'backtrack(start=0, sum=6, path=[2,2,2])'],
                        node: { displayText: '[2,2,2,2]', depth: 4, type: 'PRUNED', sum: 8, choice: 2, parent: 3, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 18,
                        description: 'å‰ªæï¼šsum(8) > target(7)ï¼Œè¿”å›',
                        variables: { result: '[]', path: '[2,2,2,2]', sum: 8 },
                        callStack: ['...', 'backtrack(start=0, sum=8) -> å‰ªæè¿”å›'],
                        node: { displayText: '[2,2,2,2]', depth: 4, type: 'PRUNED', sum: 8 }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯ï¼Œç§»é™¤ 2ï¼Œå°è¯•ä¸‹ä¸€ä¸ªå€™é€‰æ•° 3',
                        variables: { result: '[]', path: '[2,2,2]', sum: 6, i: 1 },
                        callStack: ['...', 'backtrack(start=0, sum=6, path=[2,2,2])'],
                        node: { displayText: '[2,2,2]', depth: 3, type: 'INTERNAL', sum: 6 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [2,2,3]ï¼Œå’Œ=9 > 7',
                        variables: { result: '[]', path: '[2,2,3]', sum: 9, i: 1 },
                        callStack: ['...', 'backtrack(start=0, sum=6, path=[2,2,2])'],
                        node: { displayText: '[2,2,3]', depth: 4, type: 'PRUNED', sum: 9, choice: 3, parent: 3, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 18,
                        description: 'å‰ªæï¼šsum(9) > target(7)ï¼Œè¿”å›',
                        variables: { result: '[]', path: '[2,2,3]', sum: 9 },
                        callStack: ['...', 'backtrack(start=1, sum=9) -> å‰ªæè¿”å›'],
                        node: { displayText: '[2,2,3]', depth: 4, type: 'PRUNED', sum: 9 }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯åˆ° [2,2]ï¼Œå°è¯•å€™é€‰æ•° 3',
                        variables: { result: '[]', path: '[2,2]', sum: 4, i: 1 },
                        callStack: ['...', 'backtrack(start=0, sum=2, path=[2])'],
                        node: { displayText: '[2,2]', depth: 2, type: 'INTERNAL', sum: 4 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [2,3]',
                        variables: { result: '[]', path: '[2,3]', sum: 5, i: 1 },
                        callStack: ['...', 'backtrack(start=0, sum=2, path=[2])'],
                        node: { displayText: '[2,3]', depth: 2, type: 'INTERNAL', sum: 5, choice: 3, parent: 1 }
                    },
                    {
                        line: 25,
                        description: 'é€’å½’è°ƒç”¨',
                        variables: { result: '[]', path: '[2,3]', sum: 5, start: 1 },
                        callStack: ['...', 'backtrack(start=1, sum=5, path=[2,3])'],
                        node: { displayText: '[2,3]', depth: 2, type: 'INTERNAL', sum: 5 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [2,3,3]ï¼Œå’Œ=8 > 7',
                        variables: { result: '[]', path: '[2,3,3]', sum: 8, i: 1 },
                        callStack: ['...', 'backtrack(start=1, sum=5, path=[2,3])'],
                        node: { displayText: '[2,3,3]', depth: 3, type: 'PRUNED', sum: 8, choice: 3, parent: 4, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 18,
                        description: 'å‰ªæè¿”å›',
                        variables: { result: '[]', path: '[2,3,3]', sum: 8 },
                        callStack: ['...', 'backtrack(start=1, sum=8) -> å‰ªæè¿”å›'],
                        node: { displayText: '[2,3,3]', depth: 3, type: 'PRUNED', sum: 8 }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯åˆ° [2]ï¼Œå°è¯•å€™é€‰æ•° 6',
                        variables: { result: '[]', path: '[2]', sum: 2, i: 2 },
                        callStack: ['...', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[2]', depth: 1, type: 'INTERNAL', sum: 2 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 6ï¼Œè·¯å¾„å˜ä¸º [2,6]ï¼Œå’Œ=8 > 7',
                        variables: { result: '[]', path: '[2,6]', sum: 8, i: 2 },
                        callStack: ['...', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[2,6]', depth: 2, type: 'PRUNED', sum: 8, choice: 6, parent: 1, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯åˆ° []ï¼Œå°è¯•å€™é€‰æ•° 3',
                        variables: { result: '[]', path: '[]', sum: 0, i: 1 },
                        callStack: ['combinationSum(...)', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[]', depth: 0, type: 'INTERNAL', sum: 0 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [3]',
                        variables: { result: '[]', path: '[3]', sum: 3, i: 1 },
                        callStack: ['...', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[3]', depth: 1, type: 'INTERNAL', sum: 3, choice: 3, parent: 0 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [3,3]',
                        variables: { result: '[]', path: '[3,3]', sum: 6, i: 1 },
                        callStack: ['...', 'backtrack(start=1, sum=3, path=[3])'],
                        node: { displayText: '[3,3]', depth: 2, type: 'INTERNAL', sum: 6, choice: 3, parent: 5 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [3,3,3]ï¼Œå’Œ=9 > 7',
                        variables: { result: '[]', path: '[3,3,3]', sum: 9, i: 1 },
                        callStack: ['...', 'backtrack(start=1, sum=6, path=[3,3])'],
                        node: { displayText: '[3,3,3]', depth: 3, type: 'PRUNED', sum: 9, choice: 3, parent: 6, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯åˆ° [3]ï¼Œå°è¯•å€™é€‰æ•° 6',
                        variables: { result: '[]', path: '[3]', sum: 3, i: 2 },
                        callStack: ['...', 'backtrack(start=1, sum=0, path=[])'],
                        node: { displayText: '[3]', depth: 1, type: 'INTERNAL', sum: 3 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 6ï¼Œè·¯å¾„å˜ä¸º [3,6]ï¼Œå’Œ=9 > 7',
                        variables: { result: '[]', path: '[3,6]', sum: 9, i: 2 },
                        callStack: ['...', 'backtrack(start=1, sum=3, path=[3])'],
                        node: { displayText: '[3,6]', depth: 2, type: 'PRUNED', sum: 9, choice: 6, parent: 5, reason: 'å’Œè¶…è¿‡ç›®æ ‡' }
                    },
                    {
                        line: 26,
                        description: 'å›æº¯åˆ° []ï¼Œå°è¯•å€™é€‰æ•° 7',
                        variables: { result: '[]', path: '[]', sum: 0, i: 3 },
                        callStack: ['combinationSum(...)', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[]', depth: 0, type: 'INTERNAL', sum: 0 }
                    },
                    {
                        line: 24,
                        description: 'é€‰æ‹© 7ï¼Œè·¯å¾„å˜ä¸º [7]',
                        variables: { result: '[]', path: '[7]', sum: 7, i: 3 },
                        callStack: ['...', 'backtrack(start=0, sum=0, path=[])'],
                        node: { displayText: '[7]', depth: 1, type: 'INTERNAL', sum: 7, choice: 7, parent: 0 }
                    },
                    {
                        line: 12,
                        description: 'âœ“ æ‰¾åˆ°è§£ï¼sum(7) == target(7)',
                        variables: { result: '[[7]]', path: '[7]', sum: 7 },
                        callStack: ['...', 'backtrack(start=3, sum=7) -> æ‰¾åˆ°è§£'],
                        node: { displayText: '[7]', depth: 1, type: 'LEAF', sum: 7, result: true }
                    },
                    {
                        line: 13,
                        description: 'å°† [7] åŠ å…¥ç»“æœé›†',
                        variables: { result: '[[7]]', path: '[7]' },
                        callStack: ['...'],
                        node: { displayText: '[7]', depth: 1, type: 'LEAF', sum: 7 }
                    },
                    {
                        line: 5,
                        description: 'å›æº¯å®Œæˆï¼Œè¿”å›æ‰€æœ‰ç»“æœ',
                        variables: { result: '[[7]]' },
                        callStack: ['combinationSum(...) -> è¿”å›ç»“æœ'],
                        node: null
                    }
                ]
            },
            permutations: {
                name: 'å…¨æ’åˆ—',
                code: `<span class="keyword">public</span> <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; <span class="function">permute</span>(<span class="keyword">int</span>[] nums) {
    <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; result = <span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;();
    <span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt; path = <span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;();
    <span class="keyword">boolean</span>[] used = <span class="keyword">new</span> <span class="keyword">boolean</span>[nums.length];
    <span class="function">backtrack</span>(nums, path, used, result);
    <span class="keyword">return</span> result;
}

<span class="keyword">void</span> <span class="function">backtrack</span>(<span class="keyword">int</span>[] nums, <span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt; path,
                  <span class="keyword">boolean</span>[] used,
                  <span class="keyword">List</span>&lt;<span class="keyword">List</span>&lt;<span class="keyword">Integer</span>&gt;&gt; result) {
    <span class="comment">// æ‰¾åˆ°ä¸€ä¸ªæ’åˆ—</span>
    <span class="keyword">if</span> (path.size() == nums.length) {
        result.add(<span class="keyword">new</span> <span class="keyword">ArrayList</span>&lt;&gt;(path));
        <span class="keyword">return</span>;
    }

    <span class="comment">// å°è¯•æ¯ä¸ªæœªä½¿ç”¨çš„æ•°å­—</span>
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) {
        <span class="keyword">if</span> (used[i]) <span class="keyword">continue</span>;

        path.add(nums[i]);
        used[i] = <span class="keyword">true</span>;
        <span class="function">backtrack</span>(nums, path, used, result);
        used[i] = <span class="keyword">false</span>;
        path.remove(path.size() - <span class="number">1</span>);
    }
}`,
                steps: [
                    {
                        line: 2,
                        description: 'åˆå§‹åŒ–ç»“æœåˆ—è¡¨ã€è·¯å¾„å’Œusedæ•°ç»„',
                        variables: { result: '[]', path: '[]', nums: '[1,2,3]', used: '[F,F,F]' },
                        callStack: ['permute(nums=[1,2,3])'],
                        node: { displayText: '[]', depth: 0, type: 'ROOT' }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 1ï¼ŒåŠ å…¥è·¯å¾„',
                        variables: { result: '[]', path: '[1]', used: '[T,F,F]', i: 0 },
                        callStack: ['permute(...)', 'backtrack(path=[])'],
                        node: { displayText: '[1]', depth: 1, type: 'INTERNAL', choice: 1, parent: 0 }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [1,2]',
                        variables: { result: '[]', path: '[1,2]', used: '[T,T,F]', i: 1 },
                        callStack: ['...', 'backtrack(path=[1])'],
                        node: { displayText: '[1,2]', depth: 2, type: 'INTERNAL', choice: 2, parent: 1 }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [1,2,3]',
                        variables: { result: '[]', path: '[1,2,3]', used: '[T,T,T]', i: 2 },
                        callStack: ['...', 'backtrack(path=[1,2])'],
                        node: { displayText: '[1,2,3]', depth: 3, type: 'LEAF', choice: 3, parent: 2, result: true }
                    },
                    {
                        line: 13,
                        description: 'âœ“ æ‰¾åˆ°ä¸€ä¸ªæ’åˆ—ï¼åŠ å…¥ç»“æœé›†',
                        variables: { result: '[[1,2,3]]', path: '[1,2,3]' },
                        callStack: ['...', 'backtrack(path=[1,2,3]) -> æ‰¾åˆ°è§£'],
                        node: { displayText: '[1,2,3]', depth: 3, type: 'LEAF' }
                    },
                    {
                        line: 25,
                        description: 'å›æº¯åˆ° [1]ï¼Œå°è¯• 3',
                        variables: { result: '[[1,2,3]]', path: '[1]', used: '[T,F,F]', i: 2 },
                        callStack: ['...', 'backtrack(path=[1])'],
                        node: { displayText: '[1]', depth: 1, type: 'INTERNAL' }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [1,3]',
                        variables: { result: '[[1,2,3]]', path: '[1,3]', used: '[T,F,T]', i: 2 },
                        callStack: ['...', 'backtrack(path=[1])'],
                        node: { displayText: '[1,3]', depth: 2, type: 'INTERNAL', choice: 3, parent: 1 }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [1,3,2]',
                        variables: { result: '[[1,2,3]]', path: '[1,3,2]', used: '[T,T,T]', i: 1 },
                        callStack: ['...', 'backtrack(path=[1,3])'],
                        node: { displayText: '[1,3,2]', depth: 3, type: 'LEAF', choice: 2, parent: 3, result: true }
                    },
                    {
                        line: 13,
                        description: 'âœ“ æ‰¾åˆ°æ’åˆ— [1,3,2]',
                        variables: { result: '[[1,2,3],[1,3,2]]', path: '[1,3,2]' },
                        callStack: ['...'],
                        node: { displayText: '[1,3,2]', depth: 3, type: 'LEAF' }
                    },
                    {
                        line: 25,
                        description: 'å›æº¯åˆ° []ï¼Œå°è¯• 2',
                        variables: { result: '[[1,2,3],[1,3,2]]', path: '[]', used: '[F,F,F]', i: 1 },
                        callStack: ['permute(...)', 'backtrack(path=[])'],
                        node: { displayText: '[]', depth: 0, type: 'ROOT' }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 2ï¼Œè·¯å¾„å˜ä¸º [2]',
                        variables: { result: '[[1,2,3],[1,3,2]]', path: '[2]', used: '[F,T,F]', i: 1 },
                        callStack: ['...', 'backtrack(path=[])'],
                        node: { displayText: '[2]', depth: 1, type: 'INTERNAL', choice: 2, parent: 0 }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 1ï¼Œè·¯å¾„å˜ä¸º [2,1]',
                        variables: { result: '[[1,2,3],[1,3,2]]', path: '[2,1]', used: '[T,T,F]', i: 0 },
                        callStack: ['...', 'backtrack(path=[2])'],
                        node: { displayText: '[2,1]', depth: 2, type: 'INTERNAL', choice: 1, parent: 5 }
                    },
                    {
                        line: 20,
                        description: 'é€‰æ‹© 3ï¼Œè·¯å¾„å˜ä¸º [2,1,3]',
                        variables: { result: '[[1,2,3],[1,3,2]]', path: '[2,1,3]', used: '[T,T,T]', i: 2 },
                        callStack: ['...', 'backtrack(path=[2,1])'],
                        node: { displayText: '[2,1,3]', depth: 3, type: 'LEAF', choice: 3, parent: 6, result: true }
                    },
                    {
                        line: 13,
                        description: 'âœ“ æ‰¾åˆ°æ’åˆ— [2,1,3]',
                        variables: { result: '[[1,2,3],[1,3,2],[2,1,3]]', path: '[2,1,3]' },
                        callStack: ['...'],
                        node: { displayText: '[2,1,3]', depth: 3, type: 'LEAF' }
                    },
                    {
                        line: 5,
                        description: 'å›æº¯å®Œæˆï¼Œè¿”å›æ‰€æœ‰6ä¸ªæ’åˆ—',
                        variables: { result: '[[1,2,3],[1,3,2],[2,1,3],...]' },
                        callStack: ['permute(...) -> è¿”å›ç»“æœ'],
                        node: null
                    }
                ]
            },
            maxDepth: {
                name: 'äºŒå‰æ ‘æœ€å¤§æ·±åº¦',
                code: `<span class="keyword">public</span> <span class="keyword">int</span> <span class="function">maxDepth</span>(<span class="keyword">TreeNode</span> root) {
    <span class="keyword">if</span> (root == <span class="keyword">null</span>) {
        <span class="keyword">return</span> <span class="number">0</span>;
    }

    <span class="keyword">int</span> leftDepth = <span class="function">maxDepth</span>(root.left);
    <span class="keyword">int</span> rightDepth = <span class="function">maxDepth</span>(root.right);

    <span class="keyword">return</span> Math.max(leftDepth, rightDepth) + <span class="number">1</span>;
}

<span class="comment">// äºŒå‰æ ‘èŠ‚ç‚¹</span>
<span class="keyword">class</span> <span class="keyword">TreeNode</span> {
    <span class="keyword">int</span> val;
    <span class="keyword">TreeNode</span> left, right;
    <span class="keyword">TreeNode</span>(<span class="keyword">int</span> val) { <span class="keyword">this</span>.val = val; }
}`,
                steps: [
                    {
                        line: 1,
                        description: 'è®¡ç®—æ ¹èŠ‚ç‚¹3çš„æœ€å¤§æ·±åº¦',
                        variables: { root: '3' },
                        callStack: ['maxDepth(3)'],
                        node: { displayText: '3', depth: 0, type: 'ROOT', val: 3 }
                    },
                    {
                        line: 6,
                        description: 'é€’å½’è®¡ç®—å·¦å­æ ‘(èŠ‚ç‚¹9)çš„æ·±åº¦',
                        variables: { root: '9' },
                        callStack: ['maxDepth(3)', 'maxDepth(9)'],
                        node: { displayText: '9', depth: 1, type: 'INTERNAL', val: 9, parent: 0 }
                    },
                    {
                        line: 2,
                        description: 'èŠ‚ç‚¹9çš„å·¦å­æ ‘ä¸ºnull',
                        variables: { root: 'null', returnValue: 0 },
                        callStack: ['maxDepth(3)', 'maxDepth(9)', 'maxDepth(null)'],
                        node: { displayText: 'null', depth: 2, type: 'LEAF', parent: 1, result: 0 }
                    },
                    {
                        line: 2,
                        description: 'èŠ‚ç‚¹9çš„å³å­æ ‘ä¸ºnull',
                        variables: { root: 'null', returnValue: 0 },
                        callStack: ['maxDepth(3)', 'maxDepth(9)', 'maxDepth(null)'],
                        node: { displayText: 'null', depth: 2, type: 'LEAF', parent: 1, result: 0 }
                    },
                    {
                        line: 9,
                        description: 'èŠ‚ç‚¹9è¿”å›æ·±åº¦: max(0,0)+1=1',
                        variables: { leftDepth: 0, rightDepth: 0, returnValue: 1 },
                        callStack: ['maxDepth(3)', 'maxDepth(9) -> è¿”å›1'],
                        node: { displayText: '9â†’1', depth: 1, type: 'INTERNAL', val: 9, result: 1 }
                    },
                    {
                        line: 7,
                        description: 'é€’å½’è®¡ç®—å³å­æ ‘(èŠ‚ç‚¹20)çš„æ·±åº¦',
                        variables: { root: '20', leftDepth: 1 },
                        callStack: ['maxDepth(3)', 'maxDepth(20)'],
                        node: { displayText: '20', depth: 1, type: 'INTERNAL', val: 20, parent: 0 }
                    },
                    {
                        line: 6,
                        description: 'é€’å½’è®¡ç®—èŠ‚ç‚¹20çš„å·¦å­æ ‘(èŠ‚ç‚¹15)',
                        variables: { root: '15' },
                        callStack: ['maxDepth(3)', 'maxDepth(20)', 'maxDepth(15)'],
                        node: { displayText: '15', depth: 2, type: 'INTERNAL', val: 15, parent: 3 }
                    },
                    {
                        line: 2,
                        description: 'èŠ‚ç‚¹15çš„å·¦å³å­æ ‘éƒ½ä¸ºnull',
                        variables: { root: 'null', returnValue: 0 },
                        callStack: ['...', 'maxDepth(15)', 'maxDepth(null)'],
                        node: { displayText: 'null', depth: 3, type: 'LEAF', parent: 4, result: 0 }
                    },
                    {
                        line: 9,
                        description: 'èŠ‚ç‚¹15è¿”å›æ·±åº¦: max(0,0)+1=1',
                        variables: { leftDepth: 0, rightDepth: 0, returnValue: 1 },
                        callStack: ['...', 'maxDepth(15) -> è¿”å›1'],
                        node: { displayText: '15â†’1', depth: 2, type: 'INTERNAL', val: 15, result: 1 }
                    },
                    {
                        line: 7,
                        description: 'é€’å½’è®¡ç®—èŠ‚ç‚¹20çš„å³å­æ ‘(èŠ‚ç‚¹7)',
                        variables: { root: '7' },
                        callStack: ['maxDepth(3)', 'maxDepth(20)', 'maxDepth(7)'],
                        node: { displayText: '7', depth: 2, type: 'INTERNAL', val: 7, parent: 3 }
                    },
                    {
                        line: 2,
                        description: 'èŠ‚ç‚¹7çš„å·¦å³å­æ ‘éƒ½ä¸ºnull',
                        variables: { root: 'null', returnValue: 0 },
                        callStack: ['...', 'maxDepth(7)', 'maxDepth(null)'],
                        node: { displayText: 'null', depth: 3, type: 'LEAF', parent: 5, result: 0 }
                    },
                    {
                        line: 9,
                        description: 'èŠ‚ç‚¹7è¿”å›æ·±åº¦: max(0,0)+1=1',
                        variables: { leftDepth: 0, rightDepth: 0, returnValue: 1 },
                        callStack: ['...', 'maxDepth(7) -> è¿”å›1'],
                        node: { displayText: '7â†’1', depth: 2, type: 'INTERNAL', val: 7, result: 1 }
                    },
                    {
                        line: 9,
                        description: 'èŠ‚ç‚¹20è¿”å›æ·±åº¦: max(1,1)+1=2',
                        variables: { leftDepth: 1, rightDepth: 1, returnValue: 2 },
                        callStack: ['maxDepth(3)', 'maxDepth(20) -> è¿”å›2'],
                        node: { displayText: '20â†’2', depth: 1, type: 'INTERNAL', val: 20, result: 2 }
                    },
                    {
                        line: 9,
                        description: 'âœ“ æ ¹èŠ‚ç‚¹è¿”å›æœ€å¤§æ·±åº¦: max(1,2)+1=3',
                        variables: { leftDepth: 1, rightDepth: 2, returnValue: 3 },
                        callStack: ['maxDepth(3) -> è¿”å›3'],
                        node: { displayText: '3â†’3', depth: 0, type: 'ROOT', val: 3, result: 3 }
                    }
                ]
            }
        };

        // åŠ è½½ç®—æ³•
        function loadAlgorithm() {
            const select = document.getElementById('algorithmSelect');
            currentAlgorithm = select.value;
            const algo = algorithms[currentAlgorithm];

            // æ˜¾ç¤ºä»£ç 
            const codePanel = document.getElementById('codePanel');
            const lines = algo.code.split('\n');
            codePanel.innerHTML = lines.map((line, i) =>
                `<div class="code-line" data-line="${i}">${i.toString().padStart(2, '0')}  ${line}</div>`
            ).join('');

            // åŠ è½½æ‰§è¡Œæ­¥éª¤
            executionSteps = algo.steps;
            currentStep = 0;

            // é‡ç½®UIå’Œè§†å›¾
            resetExecution();
            resetZoom();
        }

        // é‡ç½®æ‰§è¡Œ
        function resetExecution() {
            currentStep = 0;
            treeNodes = [];
            stopPlay();
            updateUI();
        }

        // ç¼©æ”¾æ§åˆ¶
        function zoomIn() {
            autoFitEnabled = false; // æ‰‹åŠ¨ç¼©æ”¾åç¦ç”¨è‡ªåŠ¨é€‚åº”
            scale *= 1.2;
            scale = Math.min(5, scale);
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
            drawTree();
        }

        function zoomOut() {
            autoFitEnabled = false; // æ‰‹åŠ¨ç¼©æ”¾åç¦ç”¨è‡ªåŠ¨é€‚åº”
            scale *= 0.8;
            scale = Math.max(0.1, scale);
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
            drawTree();
        }

        function resetZoom() {
            autoFitEnabled = true; // é‡ç½®æ—¶é‡æ–°å¯ç”¨è‡ªåŠ¨é€‚åº”
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            document.getElementById('zoomLevel').textContent = '100%';
            drawTree();
        }

        function fitToView() {
            if (treeNodes.length === 0) return;

            // å…ˆç»˜åˆ¶æ ‘ä»¥ç¡®ä¿èŠ‚ç‚¹ä½ç½®å·²è®¡ç®—
            drawTree();

            // è®¡ç®—æ ‘çš„è¾¹ç•Œ
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;

            treeNodes.forEach(node => {
                if (node.x !== undefined && node.y !== undefined) {
                    minX = Math.min(minX, node.x);
                    maxX = Math.max(maxX, node.x);
                    minY = Math.min(minY, node.y);
                    maxY = Math.max(maxY, node.y);
                }
            });

            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„è¾¹ç•Œï¼Œç›´æ¥è¿”å›
            if (!isFinite(minX)) return;

            // æ·»åŠ è¾¹è·
            const padding = 100;
            const treeWidth = maxX - minX + padding * 2;
            const treeHeight = maxY - minY + padding * 2;

            // è®¡ç®—é€‚åˆçš„ç¼©æ”¾æ¯”ä¾‹
            const rect = canvas.parentElement.getBoundingClientRect();
            const scaleX = rect.width / treeWidth;
            const scaleY = rect.height / treeHeight;
            scale = Math.min(scaleX, scaleY, 1.5); // æœ€å¤šæ”¾å¤§åˆ°150%

            // è®¡ç®—å±…ä¸­åç§»
            const treeCenterX = (minX + maxX) / 2;
            const treeCenterY = (minY + maxY) / 2;
            offsetX = rect.width / 2 - treeCenterX * scale;
            offsetY = rect.height / 2 - treeCenterY * scale;

            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
            drawTree();
        }

        // å•æ­¥å‰è¿›
        function stepForward() {
            if (currentStep < executionSteps.length - 1) {
                currentStep++;
                updateUI();
            }
        }

        // å•æ­¥åé€€
        function stepBackward() {
            if (currentStep > 0) {
                currentStep--;
                updateUI();
            }
        }

        // æ’­æ”¾/æš‚åœ
        function togglePlay() {
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }

        function startPlay() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = 'â¸ æš‚åœ';

            const speed = parseInt(document.getElementById('speedSlider').value);
            playInterval = setInterval(() => {
                if (currentStep < executionSteps.length - 1) {
                    stepForward();
                } else {
                    stopPlay();
                }
            }, speed);
        }

        function stopPlay() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            const step = executionSteps[currentStep];

            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentStep + 1) / executionSteps.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // é«˜äº®å½“å‰è¡Œ
            document.querySelectorAll('.code-line').forEach(line => {
                line.classList.remove('active', 'completed');
                const lineNum = parseInt(line.dataset.line);
                if (lineNum === step.line) {
                    line.classList.add('active');
                } else if (lineNum < step.line) {
                    line.classList.add('completed');
                }
            });

            // æ›´æ–°æ­¥éª¤è¯´æ˜
            document.getElementById('stepInfo').innerHTML =
                `<strong>æ­¥éª¤ ${currentStep + 1}/${executionSteps.length}:</strong> ${step.description}`;

            // æ›´æ–°å˜é‡
            updateVariables(step.variables);

            // æ›´æ–°è°ƒç”¨æ ˆ
            updateCallStack(step.callStack);

            // æ›´æ–°æ ‘èŠ‚ç‚¹
            if (step.node) {
                updateTree(step.node);
            }

            // æ›´æ–°ç»Ÿè®¡
            updateStats();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('stepBackBtn').disabled = currentStep === 0;
            document.getElementById('stepForwardBtn').disabled = currentStep === executionSteps.length - 1;
        }

        function updateVariables(vars) {
            const panel = document.getElementById('variablesPanel');
            panel.innerHTML = Object.entries(vars).map(([name, value]) => `
                <div class="var-item">
                    <div class="var-name">${name}</div>
                    <div class="var-value">${value}</div>
                </div>
            `).join('');
        }

        function updateCallStack(stack) {
            const panel = document.getElementById('callStack');
            panel.innerHTML = stack.map((frame, i) => `
                <div class="stack-frame ${i === stack.length - 1 ? 'active' : ''}">
                    ${frame}
                </div>
            `).reverse().join('');
        }

        function updateTree(node) {
            const previousCount = treeNodes.length;

            // æ·»åŠ æˆ–æ›´æ–°èŠ‚ç‚¹
            if (node.parent !== undefined) {
                // å­èŠ‚ç‚¹
                if (!treeNodes.some(n => n.displayText === node.displayText && n.depth === node.depth)) {
                    treeNodes.push({...node, id: treeNodes.length});
                } else {
                    // æ›´æ–°ç°æœ‰èŠ‚ç‚¹
                    const existing = treeNodes.find(n => n.displayText === node.displayText && n.depth === node.depth);
                    if (existing) {
                        Object.assign(existing, node);
                    }
                }
            } else if (!treeNodes.some(n => n.depth === 0)) {
                // æ ¹èŠ‚ç‚¹
                treeNodes.push({...node, id: 0});
            } else {
                // æ›´æ–°æ ¹èŠ‚ç‚¹
                const root = treeNodes.find(n => n.depth === 0);
                if (root) {
                    Object.assign(root, node);
                }
            }

            drawTree();

            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨é€‚åº”ä¸”æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè‡ªåŠ¨é€‚åº”çª—å£
            if (autoFitEnabled && previousCount === 0 && treeNodes.length === 1) {
                // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿èŠ‚ç‚¹ä½ç½®å·²è®¡ç®—
                setTimeout(() => fitToView(), 50);
            }
        }

        function drawTree() {
            const rect = canvas.parentElement.getBoundingClientRect();
            ctx.clearRect(0, 0, rect.width, rect.height);

            if (treeNodes.length === 0) return;

            // ä¿å­˜ä¸Šä¸‹æ–‡å¹¶åº”ç”¨ç¼©æ”¾å’Œå¹³ç§»
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);

            // æ”¹è¿›çš„æ ‘å¸ƒå±€ç®—æ³•
            const levelGap = 100;
            const minNodeGap = 80;
            const nodeRadius = 25;
            const startY = 60;

            // æ„å»ºæ ‘ç»“æ„
            const root = treeNodes.find(n => n.depth === 0);
            if (!root) return;

            // ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ childrenæ•°ç»„
            treeNodes.forEach(node => {
                node.children = treeNodes.filter(n => n.parent === node.id);
            });

            // è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å®½åº¦ï¼ˆè‡ªåº•å‘ä¸Šï¼‰
            function calculateWidth(node) {
                if (node.children.length === 0) {
                    node.width = 1;
                    return 1;
                }
                node.width = node.children.reduce((sum, child) => sum + calculateWidth(child), 0);
                return node.width;
            }
            calculateWidth(root);

            // åˆ†é…xåæ ‡ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰
            function assignPositions(node, leftBound) {
                if (node.children.length === 0) {
                    node.x = leftBound * minNodeGap + rect.width / 2 - (root.width * minNodeGap) / 2;
                    node.y = startY + node.depth * levelGap;
                    return;
                }

                let childLeft = leftBound;
                node.children.forEach(child => {
                    assignPositions(child, childLeft);
                    childLeft += child.width;
                });

                // çˆ¶èŠ‚ç‚¹å±…ä¸­äºå­èŠ‚ç‚¹
                const firstChild = node.children[0];
                const lastChild = node.children[node.children.length - 1];
                node.x = (firstChild.x + lastChild.x) / 2;
                node.y = startY + node.depth * levelGap;
            }
            assignPositions(root, 0);

            // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆä½¿ç”¨è´å¡å°”æ›²çº¿ï¼‰
            treeNodes.forEach(node => {
                if (node.parent !== undefined) {
                    const parent = treeNodes.find(n => n.id === node.parent);
                    if (parent && parent.x !== undefined && node.x !== undefined) {
                        const startX = parent.x;
                        const startY = parent.y + nodeRadius;
                        const endX = node.x;
                        const endY = node.y - nodeRadius;

                        // æ§åˆ¶ç‚¹ç”¨äºè´å¡å°”æ›²çº¿
                        const controlY = (startY + endY) / 2;

                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.bezierCurveTo(
                            startX, controlY,
                            endX, controlY,
                            endX, endY
                        );

                        // æ ¹æ®èŠ‚ç‚¹ç±»å‹è®¾ç½®è¿æ¥çº¿é¢œè‰²
                        if (node.type === 'PRUNED') {
                            ctx.strokeStyle = '#c72e0f';
                            ctx.setLineDash([5, 3]);
                        } else if (node.type === 'LEAF') {
                            ctx.strokeStyle = '#16825d';
                            ctx.setLineDash([]);
                        } else {
                            ctx.strokeStyle = '#666666';
                            ctx.setLineDash([]);
                        }
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
            });

            // ç»˜åˆ¶èŠ‚ç‚¹
            treeNodes.forEach(node => {
                if (node.x === undefined || node.y === undefined) return;

                let color = '#0e639c';
                if (node.type === 'LEAF') color = '#16825d';
                if (node.type === 'PRUNED') color = '#c72e0f';
                if (node.type === 'ROOT') color = '#4ec9b0';
                if (node.type === 'INTERNAL') color = '#0e639c';

                // åœ†å½¢èŠ‚ç‚¹
                ctx.beginPath();
                ctx.arc(node.x, node.y, nodeRadius, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#d4d4d4';
                ctx.lineWidth = 2;
                ctx.stroke();

                // èŠ‚ç‚¹æ–‡æœ¬
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 13px Consolas';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                let text = node.displayText;
                if (text.length > 8) text = text.substring(0, 7) + '..';
                ctx.fillText(text, node.x, node.y);

                // å’Œå€¼æ ‡ç­¾
                if (node.sum !== undefined) {
                    ctx.font = '11px Consolas';
                    ctx.fillStyle = '#cccccc';
                    ctx.fillText(`Î£=${node.sum}`, node.x, node.y + nodeRadius + 15);
                }

                // é€‰æ‹©æ ‡ç­¾
                if (node.choice !== undefined) {
                    ctx.font = 'bold 10px Consolas';
                    ctx.fillStyle = '#9cdcfe';
                    ctx.fillText(`+${node.choice}`, node.x - nodeRadius - 15, node.y);
                }

                // çŠ¶æ€å›¾æ ‡
                if (node.type === 'LEAF') {
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#16825d';
                    ctx.fillText('âœ“', node.x + nodeRadius + 10, node.y - nodeRadius);
                } else if (node.type === 'PRUNED') {
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#c72e0f';
                    ctx.fillText('âœ‚', node.x + nodeRadius + 10, node.y - nodeRadius);
                }
            });

            // æ¢å¤ä¸Šä¸‹æ–‡
            ctx.restore();
        }

        function updateStats() {
            const total = treeNodes.length;
            const leaves = treeNodes.filter(n => n.type === 'LEAF').length;
            const pruned = treeNodes.filter(n => n.type === 'PRUNED').length;
            const maxDepth = Math.max(...treeNodes.map(n => n.depth || 0));

            document.getElementById('statsPanel').innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">æ€»èŠ‚ç‚¹æ•°:</span>
                    <span class="stat-value">${total}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¶å­èŠ‚ç‚¹:</span>
                    <span class="stat-value">${leaves}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å‰ªæèŠ‚ç‚¹:</span>
                    <span class="stat-value">${pruned}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€å¤§æ·±åº¦:</span>
                    <span class="stat-value">${maxDepth}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å½“å‰æ­¥éª¤:</span>
                    <span class="stat-value">${currentStep + 1}/${executionSteps.length}</span>
                </div>
            `;
        }
    </script>
</body>
</html>
